# iPhoneトラックパッド化プロダクト計画（MVP / Plan Mode）

## 0. 計画方針（手戻り最小化）

本計画は、手戻りを減らすために以下の順序で固定します。

1. **先に固定**: 非目的、入力しきい値、プロトコル最小セット、受入指標（変更コストが高いもの）。
2. **後で調整**: 感度プリセット値、UI文言、テレメトリ可視化方法（変更コストが低いもの）。
3. **依存を分離**: iOS入力状態機械 / Mac入力注入 / WebSocketセッションを独立検証可能にする。
4. **計測を先行**: レイテンシ・誤認識率の測定導線をMVP初期から実装し、終盤の不確実性を下げる。

---

## 1. 目的・非目的（確定）

### 1.1 目的
- iPhoneを机上トラックパッドとして使い、Macの以下操作を低遅延で実現する。
  - ポインタ移動
  - 左クリック / 右クリック / ダブルクリック
  - ドラッグ＆ドロップ
  - 縦スクロール（横スクロールは設定ON時）
  - ズーム代替（`⌘ + scroll`）

### 1.2 非目的
- キーボード入力
- 3本指/4本指ジェスチャ
- クラウド経由遠隔操作
- ファイル転送

---

## 2. MVPスコープ定義

### 2.1 対象環境
- iPhone 12以降
- iOS 18以降（CIで固定）
- Mac: Apple Silicon優先、macOS Monterey以降
- 同一LANのみ（IPv4優先、IPv6はベストエフォート）

### 2.2 システム構成
- iOSアプリ
  - ジェスチャ認識
  - 接続管理
  - 最小UI（横固定）
  - 設定保持
- macOS常駐エージェント
  - 入力注入
  - Accessibility権限チェック
  - メニューバーUI
- 通信
  - WebSocket（`ws` / `wss`）
  - アプリ層で再接続・心拍・順序制御

---

## 3. 固定仕様（実装時に変更しない）

### 3.1 UI固定仕様
- 全面入力面
- 左上: 設定
- 右上: 接続状態 + 感度プリセット
- 触覚差分: 左クリック / 右クリック / ドラッグ開始
- 切断時: 右上状態を即時反映 + 軽通知

### 3.2 入力しきい値
- タップ最大時間: 180ms
- タップ最大移動: 10px
- ダブルタップ間隔: 250ms（設定 200/250/300ms）
- ダブルタップ位置許容: 20px
- 2本指同時接地許容: 80ms
- 長押し: 2000ms固定
- 長押し待機中キャンセル移動量: 15px
- 2本指判定ウィンドウ: 60ms
- 2本指ロック: 判定後はスクロール/ズーム切替不可

### 3.3 ジェスチャ動作
- 1本指移動: 相対移動でカーソル移動
- 1本指シングルタップ: 左クリック
- 1本指ダブルタップ: 左ダブルクリック
- 2本指タップ: 右クリック
- 1本指2秒長押し: 左ボタン押下→移動でドラッグ→離してドロップ
- 2本指同方向移動: 縦スクロール（横は設定ON時のみ）
- 2本指逆方向移動: ズーム代替（`⌘ + scroll`）

### 3.4 ピンチ→ズーム換算
- 換算式: `steps = round(k * ln(scale))`
- 既定値: `k = 12`
- 1送信クランプ: `[-4, +4]`
- デッドゾーン: `|ln(scale)| < 0.02` は送信しない
- 送信周期: 60Hz上限

### 3.5 プロトコル最小仕様
- JSON形式
- 共通項目: `type`, `ts_ms`, `seq`, `device_id`, `session_id`
- イベント: `move`, `click`, `drag_start`, `drag_move`, `drag_end`, `scroll`, `zoom`, `ping`, `pong`, `error`
- 順序保証: `seq`単調増加、欠落時は最新優先（補間せず破棄）
- 再接続: 0.5s, 1s, 2s, 4s, 最大5s

### 3.6 セキュリティ/権限
- 初回ペアリング: 6桁コード（60秒、3回失敗で無効化）
- 許可端末リスト: Mac側で明示管理、個別失効可
- 盗聴対策: 可能な環境では `wss`（TLS 1.3）
- リプレイ対策: `session_id + seq + ts_ms` 整合検証
- macOS Accessibility未許可時: 入力注入停止 + 設定誘導

---

## 4. アーキテクチャ設計（MVP）

## 4.1 iOSアプリ内部モジュール
- `InputStateMachine`
  - タッチイベント列を状態遷移で処理
  - クリック/ドラッグ/スクロール/ズームへ分類
- `GestureNormalizer`
  - ピクセル差分・速度・方向・しきい値適用
- `HapticFeedbackManager`
  - イベントごとの触覚差分
- `SessionClient`
  - WebSocket接続、seq採番、再接続、ping/pong
- `SettingsStore`
  - 感度・ダブルタップ間隔・横スクロールON/OFF保持

### 4.2 macOSエージェント内部モジュール
- `PermissionGuard`
  - Accessibility状態監視とUI誘導
- `PairingManager`
  - 6桁コード発行/検証、許可端末管理
- `WsServer`
  - iOS接続終端、セッション・順序・心拍
- `InputInjector`
  - `CGEvent`ベースの移動/クリック/ドラッグ/スクロール/修飾キー注入
- `MenuBarController`
  - 接続状態、許可端末、基本設定UI

### 4.3 メッセージフロー（正常系）
1. iOSがLAN内Macへ接続要求。
2. ペアリング済みならセッション確立、未ペアリングなら6桁照合へ遷移。
3. iOSがイベントを `seq` 付きで送信。
4. Macが整合検証後に入力注入。
5. 双方でping/pongにより3秒以内の切断検知。

---

## 5. 実装ロードマップ（依存考慮済み）

## Phase 0: 契約固定（最優先）
- P0-1: プロトコルJSONスキーマ確定（イベント型・必須項目・エラー型）
- P0-2: 入力状態機械の遷移表確定（図とテストケース同時作成）
- P0-3: 受入テスト定義（8項目）を先に固定

**完了条件**
- 後続タスクが「仕様変更なし」で並列実装できる。

## Phase 1: コア入出力
- T1: iOS入力状態機械
- T2: Mac入力注入層
- T3: WebSocketセッション層

**完了条件**
- 手動テストで移動/クリック/右クリック/ドラッグ/スクロール/ズームが成立。

## Phase 2: 接続安全性と運用性
- T4: ペアリング/端末管理
- T5: 権限ガイドUI

**完了条件**
- 未許可時の誤動作ゼロ、失効端末の再接続拒否を確認。

## Phase 3: UXと設定
- T6: 設定画面とプリセット

**完了条件**
- 感度とダブルタップ間隔変更が即時反映。

## Phase 4: 計測と受入
- T7: テレメトリ最小実装 + 評価レポート

**完了条件**
- SLO実測値と誤認識率が受入基準を満たす。

---

## 6. 受入基準（MVP判定）

### 6.1 機能成立率 8項目（各95%以上）
1. ポインタ移動
2. 左クリック
3. 左ダブルクリック
4. 右クリック
5. ドラッグ開始
6. ドラッグ終了（ドロップ）
7. 2本指スクロール
8. ズーム代替（`⌘ + scroll`）

### 6.2 品質基準
- 右クリック誤発火: < 2%
- ドラッグ誤発火: < 1%
- Finder / Safari / Previewで成立
- 30分連続試験: 切断復帰成功率 99%以上

### 6.3 SLO
- 片道入力遅延: p50 ≤ 25ms / p95 ≤ 50ms
- 切断検知: 3秒以内
- CPU平均: iPhone < 15%、Mac < 10%
- iPhoneバッテリー: 30分で < 8%
- クラッシュフリー: 99.5%以上/7日

---

## 7. テスト戦略（先行設計）

### 7.1 自動テスト
- iOSユニットテスト
  - しきい値境界（179ms/181ms, 9px/11px など）
  - 2本指判定ウィンドウ境界（59ms/61ms）
- macOSユニットテスト
  - `seq`欠落時の破棄動作
  - `session_id + seq + ts_ms` 整合不一致時の拒否
- 契約テスト
  - JSONスキーマへの準拠

### 7.2 手動E2Eテスト
- 代表アプリ3種で機能成立
- ネットワーク揺らぎ下で再接続バックオフ確認
- Accessibility未許可→許可遷移のUI検証

### 7.3 パフォーマンステスト
- 同一LANでN回試行してp50/p95を測定
- 60Hz送信時のCPUとバッテリー影響測定

---

## 8. リスクと先回り策

- **R1: ジェスチャ誤認識**
  - 対策: 状態機械に「確定前キャンセル」遷移を明示、境界テストを厚くする。
- **R2: macOS権限由来の動作不全**
  - 対策: PermissionGuardを早期実装し、注入前に必ずゲート。
- **R3: ネットワークジッタで体感劣化**
  - 対策: 60Hz上限・デッドゾーン・欠落補間なし（最新優先）で安定化。
- **R4: セキュリティ要件の後付け**
  - 対策: Phase 2までにペアリングと端末失効を必須化。

---

## 9. データポリシー実装方針

- 生タッチ座標は保存しない。
- 収集は遅延・切断回数・誤認識率・OS/機種・バージョンのみ。
- 端末IDはハッシュ化、IP非保存。
- 30日後は集約値のみ保持。
- 初回同意と設定オプトアウトを提供。

---

## 10. 初期バックログ（実行可能粒度）

1. `protocol/schema.json` 作成（イベント定義）
2. `InputStateMachine` の状態遷移図 + テストケース表
3. macOS `InputInjector` の最小注入API実装
4. iOS `SessionClient` の再接続/心拍実装
5. 6桁ペアリングフロー実装
6. Accessibility誘導UI実装
7. 設定画面（感度・ダブルタップ間隔・横スクロール）
8. テレメトリ集計とMVP評価レポート生成

---

## 11. 参照一次情報（要件トレース）

- Apple Developer Documentation: `CGEventCreateMouseEvent`
- Apple Developer Documentation: `CGEventTapCreate`
- Apple Support: Local Networkアクセス許可
- Apple Support: Accessibility許可
- RFC 6455: WebSocket
- RFC 8446: TLS 1.3

